#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Colors for terminal output
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
};

function log(message, color = colors.reset) {
  console.log(`${color}${message}${colors.reset}`);
}

function execCommand(command, errorMessage) {
  try {
    execSync(command, { stdio: 'inherit' });
    return true;
  } catch (error) {
    log(`\n‚ùå ${errorMessage}`, colors.red);
    log(`Command failed: ${command}`, colors.red);
    process.exit(1);
  }
}

function execCommandSilent(command) {
  try {
    execSync(command, { stdio: 'pipe' });
    return true;
  } catch (error) {
    return false;
  }
}

function isGitClean() {
  // Refresh git index to avoid false positives from timestamp changes
  execCommandSilent('git update-index --refresh');
  return execCommandSilent('git diff-index --quiet HEAD --');
}

function filesIdentical(file1, file2) {
  try {
    const content1 = fs.readFileSync(file1, 'utf8');
    const content2 = fs.readFileSync(file2, 'utf8');
    return content1 === content2;
  } catch (error) {
    return false;
  }
}

function showDiff(file1, file2) {
  try {
    const diff = execSync(`diff -u ${file1} ${file2}`, { encoding: 'utf8' });
    return diff;
  } catch (error) {
    return error.stdout || '';
  }
}

// Main execution
const APP_ROOT = path.resolve(__dirname, '..');
process.chdir(APP_ROOT);

console.log('== Frontend Full-Stack Template Prebuild Check ==');
console.log('');

// 0. Check if git status is clean
log('üìã Checking git status...', colors.yellow);
if (!isGitClean()) {
  log('\n‚ùå Git working directory is not clean!', colors.red);
  log('Please commit or stash your changes before running this script.', colors.red);
  try {
    execSync('git status', { stdio: 'inherit' });
  } catch (e) {}
  process.exit(1);
}
log('‚úÖ Git working directory is clean', colors.green);
console.log('');

// 1. Pull latest changes
log('üì• Pulling latest changes...', colors.yellow);
execCommand('git pull --rebase', 'Failed to pull latest changes');
log('‚úÖ Successfully pulled latest changes', colors.green);
console.log('');

// 2. Update git submodules
log('üì¶ Updating git submodules...', colors.yellow);
execCommand('git submodule update --init --recursive', 'Failed to update submodules');
log('‚úÖ Successfully updated submodules', colors.green);
console.log('');

// 3. npm install (root)
log('üì¶ Running npm install (root)...', colors.yellow);
execCommand('npm install', 'npm install failed');
log('‚úÖ npm install completed', colors.green);
console.log('');

// 4. Check if .env differs from .env.example
log('üîç Checking .env vs .env.example...', colors.yellow);
const envFile = path.join(APP_ROOT, '.env');
const envExampleFile = path.join(APP_ROOT, '.env.example');

if (!fs.existsSync(envFile)) {
  log('\n‚ùå .env file does not exist!', colors.red);
  log('Please create .env file from .env.example', colors.red);
  process.exit(1);
}

if (!fs.existsSync(envExampleFile)) {
  log('\n‚ùå .env.example file does not exist!', colors.red);
  process.exit(1);
}

if (!filesIdentical(envFile, envExampleFile)) {
  log('\n‚ùå .env differs from .env.example!', colors.red);
  log('Please manually review and sync these files:', colors.red);
  console.log('');
  console.log(showDiff(envExampleFile, envFile));
  process.exit(1);
}
log('‚úÖ .env matches .env.example', colors.green);
console.log('');

// 5. Run backend/bin/template_prebuild
log('üîß Running backend/bin/template_prebuild...', colors.yellow);
const backendPrebuild = path.join(APP_ROOT, 'backend', 'bin', 'template_prebuild');
if (!fs.existsSync(backendPrebuild)) {
  log('\n‚ùå backend/bin/template_prebuild not found!', colors.red);
  process.exit(1);
}
execCommand(backendPrebuild, 'Backend template_prebuild failed');
log('‚úÖ Backend template_prebuild completed', colors.green);
console.log('');

// 6. Final git status check
log('üìã Final git status check...', colors.yellow);
if (!isGitClean()) {
  log('\n‚ùå Git working directory is not clean after updates!', colors.red);
  log('Please review the changes:', colors.red);
  try {
    execSync('git status', { stdio: 'inherit' });
  } catch (e) {}
  process.exit(1);
}
log('‚úÖ Git working directory is still clean', colors.green);
console.log('');

// 7. All checks passed
log('üéâ ========================================', colors.green);
log('   ‚úÖ OK - All checks passed!', colors.green);
log('   Template is ready for publishing.', colors.green);
log('========================================', colors.green);

